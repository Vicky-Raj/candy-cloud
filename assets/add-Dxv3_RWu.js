import{j as e,n as ye,ad as pe,m as je,l as fe,K as I,W as be,a4 as ve,a6 as m,av as we,F as Ie,C as B,P as z,G as P,q as E,A as W,Y as Pe,o as Z,an as ee,al as Se,a0 as De,ai as R,aw as Ce,ax as ze,B as F,r as D,U as Fe,z as te,ao as b,T as l,ay as M,az as Te,R as Oe,X as $e,a3 as ke,aA as Ae,aB as qe}from"./index-CI7uwqMN.js";function C({label:p,value:a,isTextarea:T}){return e.jsxs(F,{mb:"md",children:[e.jsx(l,{size:"sm",fw:500,c:"dimmed",children:p}),T?e.jsx(z,{p:"xs",withBorder:!0,shadow:"0",children:e.jsx(l,{size:"sm",style:{whiteSpace:"pre-wrap"},children:a||"-"})}):e.jsx(l,{size:"sm",children:a||"-"})]})}const Ee=m.object({productId:m.string(),name:m.string(),image:m.string(),unitPrice:m.number(),quantity:m.number().min(1,{message:"Quantity must be at least 1"})}),Me=m.object({orderId:m.string().min(1,{message:"Order ID is required"}),orderDate:m.date({required_error:"Order date is required"}),deliveryDate:m.date().nullable().optional(),paymentType:m.string().min(1,{message:"Payment type is required"}),comments:m.string().optional(),orderItems:m.array(Ee).min(1,{message:"At least one product must be added to the order"})}).refine(p=>!(p.deliveryDate&&p.orderDate&&p.deliveryDate<p.orderDate),{message:"Delivery date cannot be before order date",path:["deliveryDate"]});function Le({addMode:p=!0,orderData:a}){const T=ye(),o=pe({from:"/customer/$customerId"}),L=(o==null?void 0:o.name)||"Customer",G=(o==null?void 0:o.mobile)||(o==null?void 0:o.phone),O=o==null?void 0:o.id,{colorScheme:v}=je(),U=fe(),[x,V]=I.useState(""),[g,H]=I.useState(!1),[se,Q]=I.useState(!1),[re,_]=I.useState(!1),c=p,u=!c&&!g,s=be({initialValues:!c&&a?a:{orderId:"",orderDate:null,deliveryDate:null,paymentType:"",comments:"",orderItems:[]},validate:ve(Me)});I.useEffect(()=>{!c&&a&&(s.setValues(a),s.resetDirty(a))},[c,a,s.setValues,s.resetDirty]);const ie=async()=>{if(!(!a||!o)){Q(!0);try{const t=new Ae,{orderId:n,orderDate:d,deliveryDate:j,paymentType:$,orderItems:Y,comments:S}=s.values;let r=20;const y=6,k=10,h=14,J=t.internal.pageSize.getWidth()-h*2;t.setFontSize(20),t.text("Invoice",t.internal.pageSize.getWidth()/2,r,{align:"center"}),r+=k,t.setFontSize(12),t.text("Customer Details:",h,r),r+=y+1,t.setFontSize(10),t.text(`Name: ${o.name}`,h,r),r+=y,G&&(t.text(`Phone: ${G}`,h,r),r+=y);let w=o.address||"";if(o.city&&(w+=`${w?", ":""}${o.city}`),o.postCode&&(w+=`${w?", ":""}${o.postCode}`),w){const i=t.splitTextToSize(`Address: ${w}`,J);t.text(i,h,r),r+=y*i.length}r+=k/2,t.setFontSize(12),t.text("Order Details:",h,r),r+=y+1,t.setFontSize(10),t.text(`Order ID: ${n}`,h,r),r+=y,t.text(`Order Date: ${d?new Date(d).toLocaleDateString():"N/A"}`,h,r),r+=y,j&&(t.text(`Delivery Date: ${new Date(j).toLocaleDateString()}`,h,r),r+=y),t.text(`Payment Type: ${$}`,h,r),r+=k;const ae=["Image","Product Name","Quantity","Unit Price","Total Price"],K=[];let X=0;if(Y.forEach(i=>{const f=i.quantity*i.unitPrice;X+=f;const A=[i.image,i.name,i.quantity,`$${i.unitPrice.toFixed(2)}`,`$${f.toFixed(2)}`];K.push(A)}),qe(t,{startY:r,head:[ae],body:K,theme:"striped",headStyles:{fillColor:[22,160,133],minCellHeight:12},columnStyles:{0:{cellWidth:25},1:{cellWidth:"auto"},2:{cellWidth:20,halign:"center"},3:{cellWidth:30,halign:"right"},4:{cellWidth:30,halign:"right"}},styles:{minCellHeight:25},didDrawCell:i=>{if(i.section==="body"&&i.column.index===0&&i.cell.raw){const f=i.cell.raw,A=2,ce=i.cell.width-2*A,ue=i.cell.height-2*A,q=Math.min(ce,ue),me=i.cell.x+(i.cell.width-q)/2,he=i.cell.y+(i.cell.height-q)/2;try{t.addImage(f,"JPEG",me,he,q,q)}catch(xe){console.error(`Error adding image ${f} to PDF:`,xe);const ge="No img";t.setFontSize(6),t.setTextColor(100),t.text(ge,i.cell.x+i.cell.width/2,i.cell.y+i.cell.height/2,{align:"center",baseline:"middle"}),t.setTextColor(0)}}},foot:[[{content:"Grand Total",colSpan:4,styles:{halign:"right",fontStyle:"bold",textColor:[0,0,0]}},{content:`$${X.toFixed(2)}`,styles:{fontStyle:"bold",textColor:[0,0,0],halign:"right"}}]],footStyles:{fontStyle:"bold",fillColor:void 0},didDrawPage:i=>{var f;r=((f=i.cursor)==null?void 0:f.y)||0}}),r=t.lastAutoTable.finalY||r,r+=k,S&&S.trim()!==""){t.setFontSize(10),t.text("Comments:",h,r),r+=y-1;const i=t.splitTextToSize(S,J);t.text(i,h,r)}const de=await t.output("bloburl");window.open(de,"_blank")}catch(t){console.error("Error generating PDF:",t)}finally{Q(!1)}}},le=c?`Add New Order for ${L}`:g?`Edit Order ${(a==null?void 0:a.orderId)||""} for ${L}`:`Order Details: ${(a==null?void 0:a.orderId)||""} for ${L}`,N=I.useMemo(()=>x.trim()?we.filter(t=>t.name.toLowerCase().includes(x.toLowerCase())||t.description.toLowerCase().includes(x.toLowerCase())).slice(0,5):[],[x]),ne=t=>{const n=s.values.orderItems,d=n.findIndex(j=>j.productId===t.id);d===-1?s.insertListItem("orderItems",{productId:t.id,name:t.name,image:t.image,unitPrice:t.price,quantity:1}):s.setFieldValue(`orderItems.${d}.quantity`,n[d].quantity+1),V("")},oe=t=>{console.log("Form submitted with values:",t),O&&T({to:`/customer/${O}/orders/`})};return e.jsxs(Ie,{p:0,pb:"xl",children:[e.jsx(B,{order:3,mb:"md",ta:"center",children:le}),e.jsxs(z,{withBorder:!0,shadow:"md",p:"sm",radius:"md",children:[!c&&!g&&e.jsxs(P,{justify:"flex-end",mb:"xs",gap:"xs",children:[!c&&e.jsx(E,{variant:"gradient",size:"xs",gradient:{from:"teal",to:"lime",deg:105},onClick:ie,loading:se,loaderProps:{type:"oval"},children:"Export to PDF"}),e.jsx(W,{variant:"outline",color:"blue",onClick:()=>H(!0),title:"Edit Order",children:e.jsx(Pe,{size:18})})]}),e.jsxs("form",{onSubmit:s.onSubmit(oe),children:[u?e.jsx(C,{label:"Order ID",value:s.values.orderId}):e.jsx(Z,{label:"Order ID",placeholder:"Enter order ID (e.g., ORD123)",required:!0,mb:"md",...s.getInputProps("orderId"),readOnly:u}),u?e.jsx(C,{label:"Order Date",value:s.values.orderDate?new Date(s.values.orderDate).toLocaleDateString():"N/A"}):e.jsx(ee,{label:"Order Date",placeholder:"Select order date",required:!0,mb:"md",valueFormat:"DD/MM/YYYY",popoverProps:{withinPortal:!0},...s.getInputProps("orderDate"),readOnly:u}),u?e.jsx(C,{label:"Delivery Date",value:s.values.deliveryDate?new Date(s.values.deliveryDate).toLocaleDateString():"N/A"}):e.jsx(ee,{label:"Delivery Date (Optional)",placeholder:"Select delivery date",mb:"md",valueFormat:"DD/MM/YYYY",popoverProps:{withinPortal:!0},minDate:s.values.orderDate||void 0,clearable:!0,...s.getInputProps("deliveryDate"),readOnly:u}),u?e.jsx(C,{label:"Payment Type",value:s.values.paymentType||"N/A"}):e.jsx(Se,{label:"Payment Type",placeholder:"Select payment type",required:!0,mb:"md",data:[{value:"Card",label:"Card"},{value:"Cash",label:"Cash"},{value:"Online",label:"Online"},{value:"Pending",label:"Pending Confirmation"}],...s.getInputProps("paymentType"),readOnly:u}),u?e.jsx(C,{label:"Comments",value:s.values.comments||"N/A",isTextarea:!0}):e.jsx(De,{label:"Comments (Optional)",placeholder:"Enter any comments for the order",mb:"xl",minRows:3,autosize:!0,...s.getInputProps("comments"),readOnly:u}),e.jsx(R,{my:"lg",label:"Order Items",labelPosition:"center"}),(c||g)&&e.jsx(P,{justify:"center",mb:"md",children:e.jsx(E,{onClick:()=>_(!0),leftSection:e.jsx(Ce,{size:16}),variant:"outline",children:"Add Products to Order"})}),e.jsxs(ze,{opened:re,onClose:()=>{_(!1),V("")},title:"Search and Add Products",size:"lg",overlayProps:{backgroundOpacity:.55,blur:3},centered:!0,children:[e.jsx(Z,{placeholder:"Type product name or description...",value:x,onChange:t=>V(t.currentTarget.value),autoFocus:!0,mb:"md"}),e.jsxs(F,{style:{maxHeight:D(350),overflowY:"auto"},children:[x&&N.length>0&&e.jsx(z,{shadow:"sm",p:"xs",withBorder:!0,children:N.map(t=>e.jsx(Fe,{onClick:()=>ne(t),style:{display:"block",width:"100%"},mb:"xs",children:e.jsx(F,{p:"xs",style:n=>({border:`1px solid ${v==="dark"?n.colors.dark[4]:n.colors.gray[3]}`,borderRadius:n.radius.sm,backgroundColor:v==="dark"?n.colors.dark[6]:n.white,transition:"background-color 100ms ease","&:hover":{backgroundColor:v==="dark"?n.colors.dark[5]:n.colors.gray[0]}}),children:e.jsxs(P,{wrap:"nowrap",gap:"md",align:"stretch",children:[e.jsx(F,{style:{flexShrink:0,width:D(50),height:D(50)},children:e.jsx(te,{src:t.image,alt:t.name,width:50,height:50,fit:"cover",radius:"sm"})}),e.jsxs(b,{direction:"column",justify:"space-between",style:{flexGrow:1,overflow:"hidden"},children:[e.jsx(B,{order:6,fw:500,lineClamp:2,children:t.name}),e.jsxs(l,{size:"xs",c:"dimmed",mt:"auto",children:["£",t.price.toFixed(2)]})]})]})})},t.id))}),x&&N.length===0&&e.jsx(z,{shadow:"sm",p:"md",withBorder:!0,children:e.jsxs(l,{size:"sm",c:"dimmed",ta:"center",children:['No products found matching "',x,'".']})}),!x&&e.jsx(l,{c:"dimmed",ta:"center",my:"xl",children:"Type in the search box above to find products."})]})]}),s.values.orderItems.length===0&&(c||g)&&e.jsx(l,{c:"dimmed",ta:"center",my:"md",children:'Use the "Add Products to Order" button to search and add items.'}),s.values.orderItems.length>0&&e.jsx(M,{variant:"default",defaultValue:"order-items-panel",mt:"md",mb:"md",p:0,styles:{content:{padding:0}},children:e.jsxs(M.Item,{value:"order-items-panel",children:[e.jsx(M.Control,{children:e.jsxs(l,{fw:500,children:["View/Edit Added Products (",s.values.orderItems.length," ","item",s.values.orderItems.length!==1?"s":"",")"]})}),e.jsx(M.Panel,{p:0,children:s.values.orderItems.map((t,n)=>e.jsxs(P,{wrap:"nowrap",align:"center",mb:"xs",p:"xs",style:d=>({border:`1px solid ${v==="dark"?d.colors.dark[4]:d.colors.gray[3]}`,borderRadius:d.radius.sm,backgroundColor:v==="dark"?d.colors.dark[6]:d.white}),children:[e.jsx(F,{style:{flexShrink:0,width:60,height:60},children:e.jsx(te,{src:t.image,alt:t.name,fit:"contain",radius:"sm"})}),e.jsxs(b,{direction:"column",justify:"space-between",style:{flexGrow:1,overflow:"hidden"},children:[e.jsx(l,{truncate:"end",fw:500,size:"sm",lineClamp:1,children:t.name}),e.jsxs(l,{size:"xs",c:"dimmed",mt:"auto",children:["£",t.unitPrice.toFixed(2)," each"]})]}),e.jsxs(b,{direction:"column",align:"flex-end",justify:"center",style:{flexShrink:0},children:[e.jsxs(P,{gap:3,wrap:"nowrap",align:"center",children:[e.jsx(W,{size:"sm",variant:"light",color:"red",onClick:()=>{const d=s.values.orderItems[n].quantity;d>1?s.setFieldValue(`orderItems.${n}.quantity`,d-1):s.removeListItem("orderItems",n)},"aria-label":"Decrease quantity",disabled:u,children:e.jsx(Te,{size:14})}),e.jsx(l,{w:D(24),ta:"center",size:"sm",fw:500,children:t.quantity}),e.jsx(W,{size:"sm",variant:"light",color:"green",onClick:()=>s.setFieldValue(`orderItems.${n}.quantity`,s.values.orderItems[n].quantity+1),"aria-label":"Increase quantity",disabled:u,children:e.jsx(Oe,{size:14})})]}),e.jsxs(l,{size:"xs",c:"dimmed",mt:D(4),children:["Total: £",(t.unitPrice*t.quantity).toFixed(2)]})]})]},t.productId))})]})}),s.values.orderItems.length>0&&e.jsxs(z,{withBorder:!0,radius:"md",p:"md",mt:"lg",children:[e.jsx(B,{order:4,mb:"sm",children:"Order Summary"}),(()=>{const t=s.values.orderItems.reduce((S,r)=>S+r.unitPrice*r.quantity,0),n=5,d=20,j=Math.max(0,t-n),$=j*(d/100),Y=j+$;return e.jsxs(e.Fragment,{children:[e.jsxs(b,{justify:"space-between",align:"center",mb:"xs",children:[e.jsx(l,{children:"Subtotal:"}),e.jsxs(l,{fw:500,children:["£",t.toFixed(2)]})]}),e.jsxs(b,{justify:"space-between",align:"center",mb:"xs",children:[e.jsx(l,{children:"Discount:"}),e.jsxs(l,{fw:500,children:["- £",n.toFixed(2)]})]}),t<n&&e.jsx(l,{c:"dimmed",size:"xs",mb:"xs",ta:"right",children:"(Discount adjusted to subtotal)"}),e.jsxs(b,{justify:"space-between",align:"center",mb:"xs",children:[e.jsx(l,{children:"Price After Discount:"}),e.jsxs(l,{fw:500,children:["£",j.toFixed(2)]})]}),e.jsxs(b,{justify:"space-between",align:"center",mb:"xs",children:[e.jsxs(l,{children:["VAT (",d,"%):"]}),e.jsxs(l,{fw:500,children:["£",$.toFixed(2)]})]}),e.jsx(R,{my:"sm"}),e.jsxs(b,{justify:"space-between",align:"center",mt:"sm",children:[e.jsx(l,{fw:700,size:"lg",children:"Grand Total:"}),e.jsxs(l,{fw:700,size:"lg",c:v==="dark"?U.colors.green[4]:U.colors.green[7],children:["£",Y.toFixed(2)]})]})]})})()]}),s.values.orderItems.length>0&&e.jsx(R,{my:"lg"}),(c||g)&&e.jsxs(P,{justify:"flex-end",mt:"xl",children:[e.jsx(E,{variant:"default",onClick:()=>{!c&&g?(H(!1),a&&s.resetDirty(a)):T({to:O?`/customer/${O}/orders/`:"/customers"})},leftSection:e.jsx($e,{size:14}),children:!c&&g?"Cancel Edit":"Cancel"}),(c||g)&&e.jsx(E,{type:"submit",leftSection:e.jsx(ke,{size:14}),disabled:u||!s.isValid()&&s.isDirty(),children:c?"Save Order":"Update Order"})]})]})]})]})}const Ne=()=>e.jsx(Le,{addMode:!0});export{Le as CustomerAddOrderPage,Ne as component};
