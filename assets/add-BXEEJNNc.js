import{j as e,n as K,ad as X,m as J,l as Z,K as y,W as ee,a4 as re,a6 as c,av as se,F as te,C as T,P as v,G as g,q as S,A,Y as ne,o as L,an as Y,al as ie,a0 as ae,ai as q,aw as le,ax as oe,B as w,r as f,U as de,z as B,ao as h,T as n,ay as k,az as ce,R as ue,X as me,a3 as xe,aA as he}from"./index-CU1GZXRK.js";function b({label:x,value:i,isTextarea:I}){return e.jsxs(w,{mb:"md",children:[e.jsx(n,{size:"sm",fw:500,c:"dimmed",children:x}),I?e.jsx(v,{p:"xs",withBorder:!0,shadow:"0",children:e.jsx(n,{size:"sm",style:{whiteSpace:"pre-wrap"},children:i||"-"})}):e.jsx(n,{size:"sm",children:i||"-"})]})}const pe=c.object({productId:c.string(),name:c.string(),image:c.string(),unitPrice:c.number(),quantity:c.number().min(1,{message:"Quantity must be at least 1"})}),je=c.object({orderId:c.string().min(1,{message:"Order ID is required"}),orderDate:c.date({required_error:"Order date is required"}),deliveryDate:c.date().nullable().optional(),paymentType:c.string().min(1,{message:"Payment type is required"}),comments:c.string().optional(),orderItems:c.array(pe).min(1,{message:"At least one product must be added to the order"})}).refine(x=>!(x.deliveryDate&&x.orderDate&&x.deliveryDate<x.orderDate),{message:"Delivery date cannot be before order date",path:["deliveryDate"]});function ye({addMode:x=!0,orderData:i}){const I=K(),l=X({from:"/customer/$customerId"}),O=(l==null?void 0:l.name)||"Customer";l!=null&&l.mobile||(l==null||l.phone);const P=l==null?void 0:l.id,{colorScheme:j}=J(),E=Z(),[u,C]=y.useState(""),[m,M]=y.useState(!1),[N,z]=y.useState(!1),[R,V]=y.useState(!1),o=x,d=!o&&!m,r=ee({initialValues:!o&&i?i:{orderId:"",orderDate:null,deliveryDate:null,paymentType:"",comments:"",orderItems:[]},validate:re(je)});y.useEffect(()=>{!o&&i&&(r.setValues(i),r.resetDirty(i))},[o,i,r.setValues,r.resetDirty]);const G=async()=>{if(!i||!l)return;z(!0);const s=new he;s.onmessage=t=>{const{success:a,blobUrl:p,error:D}=t.data;a?window.open(p,"_blank"):console.error("Error generating PDF from worker:",D),z(!1),s.terminate()},s.onerror=t=>{console.error("Worker error:",t),z(!1),s.terminate()},s.postMessage({orderData:r.values,parentCustomerData:l})},U=o?`Add New Order for ${O}`:m?`Edit Order ${(i==null?void 0:i.orderId)||""} for ${O}`:`Order Details: ${(i==null?void 0:i.orderId)||""} for ${O}`,F=y.useMemo(()=>u.trim()?se.filter(s=>s.name.toLowerCase().includes(u.toLowerCase())||s.description.toLowerCase().includes(u.toLowerCase())).slice(0,5):[],[u]),W=s=>{const t=r.values.orderItems,a=t.findIndex(p=>p.productId===s.id);a===-1?r.insertListItem("orderItems",{productId:s.id,name:s.name,image:s.image,unitPrice:s.price,quantity:1}):r.setFieldValue(`orderItems.${a}.quantity`,t[a].quantity+1),C("")},Q=s=>{console.log("Form submitted with values:",s),P&&I({to:`/customer/${P}/orders/`})};return e.jsxs(te,{p:0,pb:"xl",children:[e.jsx(T,{order:3,mb:"md",ta:"center",children:U}),e.jsxs(v,{withBorder:!0,shadow:"md",p:"sm",radius:"md",children:[!o&&!m&&e.jsxs(g,{justify:"flex-end",mb:"xs",gap:"xs",children:[!o&&e.jsx(S,{variant:"gradient",size:"xs",gradient:{from:"teal",to:"lime",deg:105},onClick:G,loading:N,loaderProps:{type:"oval"},children:"Export to PDF"}),e.jsx(A,{variant:"outline",color:"blue",onClick:()=>M(!0),title:"Edit Order",children:e.jsx(ne,{size:18})})]}),e.jsxs("form",{onSubmit:r.onSubmit(Q),children:[d?e.jsx(b,{label:"Order ID",value:r.values.orderId}):e.jsx(L,{label:"Order ID",placeholder:"Enter order ID (e.g., ORD123)",required:!0,mb:"md",...r.getInputProps("orderId"),readOnly:d}),d?e.jsx(b,{label:"Order Date",value:r.values.orderDate?new Date(r.values.orderDate).toLocaleDateString():"N/A"}):e.jsx(Y,{label:"Order Date",placeholder:"Select order date",required:!0,mb:"md",valueFormat:"DD/MM/YYYY",popoverProps:{withinPortal:!0},...r.getInputProps("orderDate"),readOnly:d}),d?e.jsx(b,{label:"Delivery Date",value:r.values.deliveryDate?new Date(r.values.deliveryDate).toLocaleDateString():"N/A"}):e.jsx(Y,{label:"Delivery Date (Optional)",placeholder:"Select delivery date",mb:"md",valueFormat:"DD/MM/YYYY",popoverProps:{withinPortal:!0},minDate:r.values.orderDate||void 0,clearable:!0,...r.getInputProps("deliveryDate"),readOnly:d}),d?e.jsx(b,{label:"Payment Type",value:r.values.paymentType||"N/A"}):e.jsx(ie,{label:"Payment Type",placeholder:"Select payment type",required:!0,mb:"md",data:[{value:"Card",label:"Card"},{value:"Cash",label:"Cash"},{value:"Online",label:"Online"},{value:"Pending",label:"Pending Confirmation"}],...r.getInputProps("paymentType"),readOnly:d}),d?e.jsx(b,{label:"Comments",value:r.values.comments||"N/A",isTextarea:!0}):e.jsx(ae,{label:"Comments (Optional)",placeholder:"Enter any comments for the order",mb:"xl",minRows:3,autosize:!0,...r.getInputProps("comments"),readOnly:d}),e.jsx(q,{my:"lg",label:"Order Items",labelPosition:"center"}),(o||m)&&e.jsx(g,{justify:"center",mb:"md",children:e.jsx(S,{onClick:()=>V(!0),leftSection:e.jsx(le,{size:16}),variant:"outline",children:"Add Products to Order"})}),e.jsxs(oe,{opened:R,onClose:()=>{V(!1),C("")},title:"Search and Add Products",size:"lg",overlayProps:{backgroundOpacity:.55,blur:3},centered:!0,children:[e.jsx(L,{placeholder:"Type product name or description...",value:u,onChange:s=>C(s.currentTarget.value),autoFocus:!0,mb:"md"}),e.jsxs(w,{style:{maxHeight:f(350),overflowY:"auto"},children:[u&&F.length>0&&e.jsx(v,{shadow:"sm",p:"xs",withBorder:!0,children:F.map(s=>e.jsx(de,{onClick:()=>W(s),style:{display:"block",width:"100%"},mb:"xs",children:e.jsx(w,{p:"xs",style:t=>({border:`1px solid ${j==="dark"?t.colors.dark[4]:t.colors.gray[3]}`,borderRadius:t.radius.sm,backgroundColor:j==="dark"?t.colors.dark[6]:t.white,transition:"background-color 100ms ease","&:hover":{backgroundColor:j==="dark"?t.colors.dark[5]:t.colors.gray[0]}}),children:e.jsxs(g,{wrap:"nowrap",gap:"md",align:"stretch",children:[e.jsx(w,{style:{flexShrink:0,width:f(50),height:f(50)},children:e.jsx(B,{src:s.image,alt:s.name,width:50,height:50,fit:"cover",radius:"sm"})}),e.jsxs(h,{direction:"column",justify:"space-between",style:{flexGrow:1,overflow:"hidden"},children:[e.jsx(T,{order:6,fw:500,lineClamp:2,children:s.name}),e.jsxs(n,{size:"xs",c:"dimmed",mt:"auto",children:["£",s.price.toFixed(2)]})]})]})})},s.id))}),u&&F.length===0&&e.jsx(v,{shadow:"sm",p:"md",withBorder:!0,children:e.jsxs(n,{size:"sm",c:"dimmed",ta:"center",children:['No products found matching "',u,'".']})}),!u&&e.jsx(n,{c:"dimmed",ta:"center",my:"xl",children:"Type in the search box above to find products."})]})]}),r.values.orderItems.length===0&&(o||m)&&e.jsx(n,{c:"dimmed",ta:"center",my:"md",children:'Use the "Add Products to Order" button to search and add items.'}),r.values.orderItems.length>0&&e.jsx(k,{variant:"default",defaultValue:"order-items-panel",mt:"md",mb:"md",p:0,styles:{content:{padding:0}},children:e.jsxs(k.Item,{value:"order-items-panel",children:[e.jsx(k.Control,{children:e.jsxs(n,{fw:500,children:["View/Edit Added Products (",r.values.orderItems.length," ","item",r.values.orderItems.length!==1?"s":"",")"]})}),e.jsx(k.Panel,{p:0,children:r.values.orderItems.map((s,t)=>e.jsxs(g,{wrap:"nowrap",align:"center",mb:"xs",p:"xs",style:a=>({border:`1px solid ${j==="dark"?a.colors.dark[4]:a.colors.gray[3]}`,borderRadius:a.radius.sm,backgroundColor:j==="dark"?a.colors.dark[6]:a.white}),children:[e.jsx(w,{style:{flexShrink:0,width:60,height:60},children:e.jsx(B,{src:s.image,alt:s.name,fit:"contain",radius:"sm"})}),e.jsxs(h,{direction:"column",justify:"space-between",style:{flexGrow:1,overflow:"hidden"},children:[e.jsx(n,{truncate:"end",fw:500,size:"sm",lineClamp:1,children:s.name}),e.jsxs(n,{size:"xs",c:"dimmed",mt:"auto",children:["£",s.unitPrice.toFixed(2)," each"]})]}),e.jsxs(h,{direction:"column",align:"flex-end",justify:"center",style:{flexShrink:0},children:[e.jsxs(g,{gap:3,wrap:"nowrap",align:"center",children:[e.jsx(A,{size:"sm",variant:"light",color:"red",onClick:()=>{const a=r.values.orderItems[t].quantity;a>1?r.setFieldValue(`orderItems.${t}.quantity`,a-1):r.removeListItem("orderItems",t)},"aria-label":"Decrease quantity",disabled:d,children:e.jsx(ce,{size:14})}),e.jsx(n,{w:f(24),ta:"center",size:"sm",fw:500,children:s.quantity}),e.jsx(A,{size:"sm",variant:"light",color:"green",onClick:()=>r.setFieldValue(`orderItems.${t}.quantity`,r.values.orderItems[t].quantity+1),"aria-label":"Increase quantity",disabled:d,children:e.jsx(ue,{size:14})})]}),e.jsxs(n,{size:"xs",c:"dimmed",mt:f(4),children:["Total: £",(s.unitPrice*s.quantity).toFixed(2)]})]})]},s.productId))})]})}),r.values.orderItems.length>0&&e.jsxs(v,{withBorder:!0,radius:"md",p:"md",mt:"lg",children:[e.jsx(T,{order:4,mb:"sm",children:"Order Summary"}),(()=>{const s=r.values.orderItems.reduce((H,$)=>H+$.unitPrice*$.quantity,0),t=5,a=20,p=Math.max(0,s-t),D=p*(a/100),_=p+D;return e.jsxs(e.Fragment,{children:[e.jsxs(h,{justify:"space-between",align:"center",mb:"xs",children:[e.jsx(n,{children:"Subtotal:"}),e.jsxs(n,{fw:500,children:["£",s.toFixed(2)]})]}),e.jsxs(h,{justify:"space-between",align:"center",mb:"xs",children:[e.jsx(n,{children:"Discount:"}),e.jsxs(n,{fw:500,children:["- £",t.toFixed(2)]})]}),s<t&&e.jsx(n,{c:"dimmed",size:"xs",mb:"xs",ta:"right",children:"(Discount adjusted to subtotal)"}),e.jsxs(h,{justify:"space-between",align:"center",mb:"xs",children:[e.jsx(n,{children:"Price After Discount:"}),e.jsxs(n,{fw:500,children:["£",p.toFixed(2)]})]}),e.jsxs(h,{justify:"space-between",align:"center",mb:"xs",children:[e.jsxs(n,{children:["VAT (",a,"%):"]}),e.jsxs(n,{fw:500,children:["£",D.toFixed(2)]})]}),e.jsx(q,{my:"sm"}),e.jsxs(h,{justify:"space-between",align:"center",mt:"sm",children:[e.jsx(n,{fw:700,size:"lg",children:"Grand Total:"}),e.jsxs(n,{fw:700,size:"lg",c:j==="dark"?E.colors.green[4]:E.colors.green[7],children:["£",_.toFixed(2)]})]})]})})()]}),r.values.orderItems.length>0&&e.jsx(q,{my:"lg"}),(o||m)&&e.jsxs(g,{justify:"flex-end",mt:"xl",children:[e.jsx(S,{variant:"default",onClick:()=>{!o&&m?(M(!1),i&&r.resetDirty(i)):I({to:P?`/customer/${P}/orders/`:"/customers"})},leftSection:e.jsx(me,{size:14}),children:!o&&m?"Cancel Edit":"Cancel"}),(o||m)&&e.jsx(S,{type:"submit",leftSection:e.jsx(xe,{size:14}),disabled:d||!r.isValid()&&r.isDirty(),children:o?"Save Order":"Update Order"})]})]})]})]})}const fe=()=>e.jsx(ye,{addMode:!0});export{ye as CustomerAddOrderPage,fe as component};
