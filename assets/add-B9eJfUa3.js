import{j as e,n as X,ad as _,m as J,l as Z,K as g,W as ee,a4 as re,a6 as c,av as se,F as te,C as q,P as w,G as b,q as S,A as E,Y as ne,o as Y,an as B,al as ae,a0 as ie,ai as M,aw as le,ax as de,B as I,r as f,U as oe,z as N,ao as p,T as n,ay as C,az as ce,R as ue,X as me,a3 as xe,aA as he}from"./index-CaXzYt8P.js";function v({label:x,value:a,isTextarea:P}){return e.jsxs(I,{mb:"md",children:[e.jsx(n,{size:"sm",fw:500,c:"dimmed",children:x}),P?e.jsx(w,{p:"xs",withBorder:!0,shadow:"0",children:e.jsx(n,{size:"sm",style:{whiteSpace:"pre-wrap"},children:a||"-"})}):e.jsx(n,{size:"sm",children:a||"-"})]})}const pe=c.object({productId:c.string(),name:c.string(),image:c.string(),unitPrice:c.number(),quantity:c.number().min(1,{message:"Quantity must be at least 1"})}),je=c.object({orderId:c.string().min(1,{message:"Order ID is required"}),orderDate:c.date({required_error:"Order date is required"}),deliveryDate:c.date().nullable().optional(),paymentType:c.string().min(1,{message:"Payment type is required"}),comments:c.string().optional(),orderItems:c.array(pe).min(1,{message:"At least one product must be added to the order"})}).refine(x=>!(x.deliveryDate&&x.orderDate&&x.deliveryDate<x.orderDate),{message:"Delivery date cannot be before order date",path:["deliveryDate"]});function ye({addMode:x=!0,orderData:a}){const P=X(),l=_({from:"/customer/$customerId"}),z=(l==null?void 0:l.name)||"Customer";l!=null&&l.mobile||(l==null||l.phone);const O=l==null?void 0:l.id,{colorScheme:y}=J(),L=Z(),[u,F]=g.useState(""),[m,$]=g.useState(!1),[U,T]=g.useState(!1),[G,V]=g.useState(!1),d=x,o=!d&&!m,r=ee({initialValues:!d&&a?a:{orderId:"",orderDate:null,deliveryDate:null,paymentType:"",comments:"",orderItems:[]},validate:re(je)});g.useEffect(()=>{!d&&a&&(r.setValues(a),r.resetDirty(a))},[d,a,r.setValues,r.resetDirty]);const W=async()=>{if(!a||!l)return;T(!0);const s=new he;s.onmessage=t=>{const{success:i,blob:h,error:k}=t.data;if(i&&h){const D=URL.createObjectURL(h),j=document.createElement("a");j.href=D,j.download=`Invoice-${r.values.orderId||"details"}.pdf`,document.body.appendChild(j),j.click(),document.body.removeChild(j),URL.revokeObjectURL(D)}else console.error("Error generating PDF from worker:",k);T(!1),s.terminate()},s.onerror=t=>{console.error("Worker error:",t),T(!1),s.terminate()},s.postMessage({orderData:r.values,parentCustomerData:l})},Q=d?`Add New Order for ${z}`:m?`Edit Order ${(a==null?void 0:a.orderId)||""} for ${z}`:`Order Details: ${(a==null?void 0:a.orderId)||""} for ${z}`,A=g.useMemo(()=>u.trim()?se.filter(s=>s.name.toLowerCase().includes(u.toLowerCase())||s.description.toLowerCase().includes(u.toLowerCase())).slice(0,5):[],[u]),H=s=>{const t=r.values.orderItems,i=t.findIndex(h=>h.productId===s.id);i===-1?r.insertListItem("orderItems",{productId:s.id,name:s.name,image:s.image,unitPrice:s.price,quantity:1}):r.setFieldValue(`orderItems.${i}.quantity`,t[i].quantity+1),F("")},K=s=>{console.log("Form submitted with values:",s),O&&P({to:`/customer/${O}/orders/`})};return e.jsxs(te,{p:0,pb:"xl",children:[e.jsx(q,{order:3,mb:"md",ta:"center",children:Q}),e.jsxs(w,{withBorder:!0,shadow:"md",p:"sm",radius:"md",children:[!d&&!m&&e.jsxs(b,{justify:"flex-end",mb:"xs",gap:"xs",children:[!d&&e.jsx(S,{variant:"gradient",size:"xs",gradient:{from:"teal",to:"lime",deg:105},onClick:W,loading:U,loaderProps:{type:"oval"},children:"Export to PDF"}),e.jsx(E,{variant:"outline",color:"blue",onClick:()=>$(!0),title:"Edit Order",children:e.jsx(ne,{size:18})})]}),e.jsxs("form",{onSubmit:r.onSubmit(K),children:[o?e.jsx(v,{label:"Order ID",value:r.values.orderId}):e.jsx(Y,{label:"Order ID",placeholder:"Enter order ID (e.g., ORD123)",required:!0,mb:"md",...r.getInputProps("orderId"),readOnly:o}),o?e.jsx(v,{label:"Order Date",value:r.values.orderDate?new Date(r.values.orderDate).toLocaleDateString():"N/A"}):e.jsx(B,{label:"Order Date",placeholder:"Select order date",required:!0,mb:"md",valueFormat:"DD/MM/YYYY",popoverProps:{withinPortal:!0},...r.getInputProps("orderDate"),readOnly:o}),o?e.jsx(v,{label:"Delivery Date",value:r.values.deliveryDate?new Date(r.values.deliveryDate).toLocaleDateString():"N/A"}):e.jsx(B,{label:"Delivery Date (Optional)",placeholder:"Select delivery date",mb:"md",valueFormat:"DD/MM/YYYY",popoverProps:{withinPortal:!0},minDate:r.values.orderDate||void 0,clearable:!0,...r.getInputProps("deliveryDate"),readOnly:o}),o?e.jsx(v,{label:"Payment Type",value:r.values.paymentType||"N/A"}):e.jsx(ae,{label:"Payment Type",placeholder:"Select payment type",required:!0,mb:"md",data:[{value:"Card",label:"Card"},{value:"Cash",label:"Cash"},{value:"Online",label:"Online"},{value:"Pending",label:"Pending Confirmation"}],...r.getInputProps("paymentType"),readOnly:o}),o?e.jsx(v,{label:"Comments",value:r.values.comments||"N/A",isTextarea:!0}):e.jsx(ie,{label:"Comments (Optional)",placeholder:"Enter any comments for the order",mb:"xl",minRows:3,autosize:!0,...r.getInputProps("comments"),readOnly:o}),e.jsx(M,{my:"lg",label:"Order Items",labelPosition:"center"}),(d||m)&&e.jsx(b,{justify:"center",mb:"md",children:e.jsx(S,{onClick:()=>V(!0),leftSection:e.jsx(le,{size:16}),variant:"outline",children:"Add Products to Order"})}),e.jsxs(de,{opened:G,onClose:()=>{V(!1),F("")},title:"Search and Add Products",size:"lg",overlayProps:{backgroundOpacity:.55,blur:3},centered:!0,children:[e.jsx(Y,{placeholder:"Type product name or description...",value:u,onChange:s=>F(s.currentTarget.value),autoFocus:!0,mb:"md"}),e.jsxs(I,{style:{maxHeight:f(350),overflowY:"auto"},children:[u&&A.length>0&&e.jsx(w,{shadow:"sm",p:"xs",withBorder:!0,children:A.map(s=>e.jsx(oe,{onClick:()=>H(s),style:{display:"block",width:"100%"},mb:"xs",children:e.jsx(I,{p:"xs",style:t=>({border:`1px solid ${y==="dark"?t.colors.dark[4]:t.colors.gray[3]}`,borderRadius:t.radius.sm,backgroundColor:y==="dark"?t.colors.dark[6]:t.white,transition:"background-color 100ms ease","&:hover":{backgroundColor:y==="dark"?t.colors.dark[5]:t.colors.gray[0]}}),children:e.jsxs(b,{wrap:"nowrap",gap:"md",align:"stretch",children:[e.jsx(I,{style:{flexShrink:0,width:f(50),height:f(50)},children:e.jsx(N,{src:s.image,alt:s.name,width:50,height:50,fit:"cover",radius:"sm"})}),e.jsxs(p,{direction:"column",justify:"space-between",style:{flexGrow:1,overflow:"hidden"},children:[e.jsx(q,{order:6,fw:500,lineClamp:2,children:s.name}),e.jsxs(n,{size:"xs",c:"dimmed",mt:"auto",children:["£",s.price.toFixed(2)]})]})]})})},s.id))}),u&&A.length===0&&e.jsx(w,{shadow:"sm",p:"md",withBorder:!0,children:e.jsxs(n,{size:"sm",c:"dimmed",ta:"center",children:['No products found matching "',u,'".']})}),!u&&e.jsx(n,{c:"dimmed",ta:"center",my:"xl",children:"Type in the search box above to find products."})]})]}),r.values.orderItems.length===0&&(d||m)&&e.jsx(n,{c:"dimmed",ta:"center",my:"md",children:'Use the "Add Products to Order" button to search and add items.'}),r.values.orderItems.length>0&&e.jsx(C,{variant:"default",defaultValue:"order-items-panel",mt:"md",mb:"md",p:0,styles:{content:{padding:0}},children:e.jsxs(C.Item,{value:"order-items-panel",children:[e.jsx(C.Control,{children:e.jsxs(n,{fw:500,children:["View/Edit Added Products (",r.values.orderItems.length," ","item",r.values.orderItems.length!==1?"s":"",")"]})}),e.jsx(C.Panel,{p:0,children:r.values.orderItems.map((s,t)=>e.jsxs(b,{wrap:"nowrap",align:"center",mb:"xs",p:"xs",style:i=>({border:`1px solid ${y==="dark"?i.colors.dark[4]:i.colors.gray[3]}`,borderRadius:i.radius.sm,backgroundColor:y==="dark"?i.colors.dark[6]:i.white}),children:[e.jsx(I,{style:{flexShrink:0,width:60,height:60},children:e.jsx(N,{src:s.image,alt:s.name,fit:"contain",radius:"sm"})}),e.jsxs(p,{direction:"column",justify:"space-between",style:{flexGrow:1,overflow:"hidden"},children:[e.jsx(n,{truncate:"end",fw:500,size:"sm",lineClamp:1,children:s.name}),e.jsxs(n,{size:"xs",c:"dimmed",mt:"auto",children:["£",s.unitPrice.toFixed(2)," each"]})]}),e.jsxs(p,{direction:"column",align:"flex-end",justify:"center",style:{flexShrink:0},children:[e.jsxs(b,{gap:3,wrap:"nowrap",align:"center",children:[e.jsx(E,{size:"sm",variant:"light",color:"red",onClick:()=>{const i=r.values.orderItems[t].quantity;i>1?r.setFieldValue(`orderItems.${t}.quantity`,i-1):r.removeListItem("orderItems",t)},"aria-label":"Decrease quantity",disabled:o,children:e.jsx(ce,{size:14})}),e.jsx(n,{w:f(24),ta:"center",size:"sm",fw:500,children:s.quantity}),e.jsx(E,{size:"sm",variant:"light",color:"green",onClick:()=>r.setFieldValue(`orderItems.${t}.quantity`,r.values.orderItems[t].quantity+1),"aria-label":"Increase quantity",disabled:o,children:e.jsx(ue,{size:14})})]}),e.jsxs(n,{size:"xs",c:"dimmed",mt:f(4),children:["Total: £",(s.unitPrice*s.quantity).toFixed(2)]})]})]},s.productId))})]})}),r.values.orderItems.length>0&&e.jsxs(w,{withBorder:!0,radius:"md",p:"md",mt:"lg",children:[e.jsx(q,{order:4,mb:"sm",children:"Order Summary"}),(()=>{const s=r.values.orderItems.reduce((j,R)=>j+R.unitPrice*R.quantity,0),t=5,i=20,h=Math.max(0,s-t),k=h*(i/100),D=h+k;return e.jsxs(e.Fragment,{children:[e.jsxs(p,{justify:"space-between",align:"center",mb:"xs",children:[e.jsx(n,{children:"Subtotal:"}),e.jsxs(n,{fw:500,children:["£",s.toFixed(2)]})]}),e.jsxs(p,{justify:"space-between",align:"center",mb:"xs",children:[e.jsx(n,{children:"Discount:"}),e.jsxs(n,{fw:500,children:["- £",t.toFixed(2)]})]}),s<t&&e.jsx(n,{c:"dimmed",size:"xs",mb:"xs",ta:"right",children:"(Discount adjusted to subtotal)"}),e.jsxs(p,{justify:"space-between",align:"center",mb:"xs",children:[e.jsx(n,{children:"Price After Discount:"}),e.jsxs(n,{fw:500,children:["£",h.toFixed(2)]})]}),e.jsxs(p,{justify:"space-between",align:"center",mb:"xs",children:[e.jsxs(n,{children:["VAT (",i,"%):"]}),e.jsxs(n,{fw:500,children:["£",k.toFixed(2)]})]}),e.jsx(M,{my:"sm"}),e.jsxs(p,{justify:"space-between",align:"center",mt:"sm",children:[e.jsx(n,{fw:700,size:"lg",children:"Grand Total:"}),e.jsxs(n,{fw:700,size:"lg",c:y==="dark"?L.colors.green[4]:L.colors.green[7],children:["£",D.toFixed(2)]})]})]})})()]}),r.values.orderItems.length>0&&e.jsx(M,{my:"lg"}),(d||m)&&e.jsxs(b,{justify:"flex-end",mt:"xl",children:[e.jsx(S,{variant:"default",onClick:()=>{!d&&m?($(!1),a&&r.resetDirty(a)):P({to:O?`/customer/${O}/orders/`:"/customers"})},leftSection:e.jsx(me,{size:14}),children:!d&&m?"Cancel Edit":"Cancel"}),(d||m)&&e.jsx(S,{type:"submit",leftSection:e.jsx(xe,{size:14}),disabled:o||!r.isValid()&&r.isDirty(),children:d?"Save Order":"Update Order"})]})]})]})]})}const be=()=>e.jsx(ye,{addMode:!0});export{ye as CustomerAddOrderPage,be as component};
